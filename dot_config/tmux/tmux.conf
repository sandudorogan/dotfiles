# ============================================
# TMUX CONFIGURATION
# ~/.config/tmux/tmux.conf
# ============================================

# ----------------------------------------
# 1. TERMINAL & COMPATIBILITY
# ----------------------------------------
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",alacritty:RGB,xterm-256color:RGB"

# ----------------------------------------
# 2. GENERAL SETTINGS
# ----------------------------------------
set -g prefix C-s
unbind C-b
bind C-s send-prefix

set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -sg escape-time 10
set -g mouse on
set -g default-shell /bin/zsh
set -g history-limit 100000
set -g focus-events on
set -g status-keys emacs

setw -g word-separators ' @"=()[]_-:,.'
setw -ag word-separators "'"

setw -g monitor-activity on
set -g visual-activity off
set -g display-panes-time 800
set -g display-time 1000

# ----------------------------------------
# 3. KEY BINDINGS
# ----------------------------------------
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"
bind C-f last-window
bind x kill-pane

# Splits preserve current path
bind '"' split-window -v -c "#{pane_current_path}"
bind '%' split-window -h -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# Pane resizing
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ----------------------------------------
# 4. COPY MODE
# ----------------------------------------
setw -g mode-keys vi
bind Enter copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send-keys -X cancel

# ----------------------------------------
# 5. APPEARANCE
# ----------------------------------------
set -g status-position top

# ----------------------------------------
# 6. VS CODE INTEGRATION
# ----------------------------------------
if-shell '[ -n "$VSCODE_GIT_ASKPASS_NODE" ]' \
    'set -g @vscode-session "vscode"'
if-shell '[ -n "$VSCODE_GIT_ASKPASS_NODE" ]' \
    'if-shell "! tmux has-session -t $TMUX_SESSION 2>/dev/null" \
        "new-session -d -s $TMUX_SESSION"'
if-shell '[ -n "$VSCODE_GIT_ASKPASS_NODE" ]' \
    'if-shell "! tmux list-panes -t $TMUX_SESSION | grep -q ." \
        "split-window -h -t $TMUX_SESSION"'
if-shell '[ -n "$VSCODE_GIT_ASKPASS_NODE" ]' \
    'set-hook -g client-detached "if-shell \"#{alternate_on}\" \"kill-window\""'
if-shell '[ -n "$VSCODE_GIT_ASKPASS_NODE" ]' \
    'set-hook -g pane-died "if-shell \"#{alternate_on}\" \"kill-window\""'

# ----------------------------------------
# 7. PLUGINS
# ----------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'jaclu/tmux-menus'
set -g @plugin 'fabioluciano/tmux-tokyo-night'

# ----------------------------------------
# 8. PLUGIN CONFIGURATION
# ----------------------------------------
# Resurrect & Continuum
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'

# Tokyo Night Theme (Storm variant)
set -g @theme_variation 'storm'
set -g @theme_left_separator ''
set -g @theme_right_separator ''
set -g @theme_plugins 'datetime,battery'
set -g @theme_plugin_datetime_format '%a %d %b %H:%M'
set -g @theme_plugin_datetime_icon 'ó°ƒ° '
set -g @theme_plugin_battery_red_threshold 10
set -g @theme_plugin_battery_yellow_threshold 30

# Window icons
set -g @theme_plugin_active_window_icon ' '
set -g @theme_plugin_inactive_window_icon ' '
set -g @theme_plugin_zoomed_window_icon ' '

# Thumbs (Vimium-style copy hints)
set -g @thumbs-key F
set -g @thumbs-alphabet qwerty-homerow
set -g @thumbs-unique enabled
set -g @thumbs-command 'echo -n {} | pbcopy'
set -g @thumbs-upcase-command 'echo -n {} | pbcopy && tmux paste-buffer'

# Extrakto (fuzzy text extraction)
set -g @extrakto_key e
set -g @extrakto_split_size 12
set -g @extrakto_clip_tool 'pbcopy'
set -g @extrakto_copy_key 'tab'
set -g @extrakto_insert_key 'enter'

# Menus
set -g @menus_trigger m

# ----------------------------------------
# 9. TPM INITIALIZATION (MUST BE LAST)
# ----------------------------------------
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

run '~/.config/tmux/plugins/tpm/tpm'
